name: Build iOS from ZIP (Tylko Xcode Archive .xcarchive)

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: 1 Checkout repo
        uses: actions/checkout@v4

      - name: 2 Extract workspace ZIP
        run: |
          mkdir -p workspace
          unzip -q ./ios-workspace.zip -d ./workspace
          echo "Zawartość workspace:"
          ls -R workspace || true

      - name: 3 Select Xcode and check version
        run: |
          # Domyślnie na macos-latest jest już wybrana najnowsza stabilna wersja
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: 4 Ustaw Schemat Aplikacji
        run: |
          echo "APP_SCHEME=EKEP" >> $GITHUB_ENV
          # WAZNE: Zmieniamy nazwe zmiennej, zeby lepiej opisywala artefakt
          echo "ARCHIVE_PATH=$RUNNER_TEMP/EKEP.xcarchive" >> $GITHUB_ENV
          echo "Używany schemat EKEP"

      - name: 5 Usuń problematyczną wtyczkę InAppBrowser
        run: |
          cd workspace
          # Usuń folder wtyczki. Ścieżka zakłada standardową strukturę projektu Cordova.
          PLUGIN_DIR="EKEP/Plugins/cordova-plugin-inappbrowser"
          if [ -d "$PLUGIN_DIR" ]; then
            rm -rf "$PLUGIN_DIR"
            echo "Usunięto folder: $PLUGIN_DIR"
          else
            echo "Folder $PLUGIN_DIR nie istnieje. Kontynuuję."
          fi
          
      - name: 6 Archiwizacja (Archive) - Pelne wylaczenie podpisywania
        run: |
          cd workspace
          
          xcodebuild \
            -workspace EKEP.xcworkspace \
            -scheme "${{ env.APP_SCHEME }}" \
            -sdk iphoneos \
            -configuration Release \
            archive \
            -archivePath "${{ env.ARCHIVE_PATH }}" \
            
            # Flagi kompatybilnosci dla Ionic 1 na nowym Xcode
            IPHONEOS_DEPLOYMENT_TARGET=12.0 \
            COMPILER_INDEX_STORE_ENABLE=NO \
            
            # Wylaczenie podpisywania (Code Signing)
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build | tee ./archive_log.txt

      - name: 7 Upload Xcode Archive Artifact
        uses: actions/upload-artifact@v4
        with:
          name: xcode-archive-ekep
          path: ${{ env.ARCHIVE_PATH }}
          
      # UWAGA: Kroki 7, 8, 10 i 11 zostaly usuniete/zastapione
