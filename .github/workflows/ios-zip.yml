name: Build iOS from ZIP in repo

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract workspace ZIP
        run: |
          mkdir -p workspace
          unzip -q ./ios-workspace.zip -d ./workspace
          echo "üìÇ Zawarto≈õƒá workspace:"
          ls -R workspace || true

      - name: Select Xcode and check version
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Build iOS app (Release, no signing)
        run: |
          cd workspace
          SCHEME=$(xcodebuild -list -json | jq -r '.workspace.schemes[0] // .project.schemes[0]')
          echo "üì¶ Scheme: $SCHEME"

          xcodebuild \
            -workspace EKEP.xcworkspace \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build | tee ./build_log.txt

      - name: Znajd≈∫ i skopiuj plik .app (Poprawiona Wersja)
        run: |
          # 1. Zlokalizuj katalog wynikowy kompilacji (.app)
          # Szukamy katalogu 'Release-iphoneos' wewnƒÖtrz DerivedData.
          # U≈ºycie -path '*Release-iphoneos' zapewni, ≈ºe znajdziemy w≈Ça≈õciwy katalog Build/Products.
          BUILD_PRODUCTS_PATH=$(find /Users/runner/Library/Developer/Xcode/DerivedData -type d -name "Release-iphoneos" 2>/dev/null | grep 'Products/Release-iphoneos')
          
          if [ -z "$BUILD_PRODUCTS_PATH" ]; then
            echo "‚ùå B≈ÇƒÖd: Nie znaleziono katalogu 'Release-iphoneos' w DerivedData."
            exit 1
          fi
          
          # 2. Znajd≈∫ plik .app w znalezionym katalogu
          # U≈ºywamy ≈õcie≈ºki znalezionej w kroku 1
          APP_PATH=$(find "$BUILD_PRODUCTS_PATH" -type d -name "*.app" -maxdepth 1)
      
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå B≈ÇƒÖd: Nie znaleziono pliku .app w ≈õcie≈ºce: $BUILD_PRODUCTS_PATH"
            exit 1
          fi
      
          # 3. Kopiowanie i przesy≈Çanie jako Artifact
          mkdir -p artifacts
          cp -R "$APP_PATH" artifacts/
          
          echo "‚úÖ Plik .app znaleziony: $APP_PATH"
          echo "‚úÖ Skopiowany do: artifacts/"
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-ios-app
          path: artifacts/

      - name: Archive full post-build workspace
        run: |
          echo "üì¶ Tworzenie archiwum ko≈Ñcowego stanu projektu..."
          cd workspace
          zip -r ../ios_full_build.zip . -x "*.git*" -x "*node_modules*" -x "*.DS_Store*"
          cd ..
      
      - name: Upload full build ZIP
        uses: actions/upload-artifact@v4
        with:
          name: ios-full-build
          path: ios_full_build.zip


