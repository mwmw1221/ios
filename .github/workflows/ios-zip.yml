name: Build iOS from ZIP in Repo

on:
  workflow_dispatch:
    inputs:
      zip_path:
        description: "≈öcie≈ºka do ZIPa z workspace Ionic (np. ./ios-workspace.zip)"
        required: true
        default: "./ios-workspace.zip"

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Verify ZIP presence
        run: |
          if [ ! -f "${{ github.event.inputs.zip_path }}" ]; then
            echo "‚ùå Nie znaleziono pliku ZIP: ${{ github.event.inputs.zip_path }}"
            exit 1
          fi
          echo "‚úÖ ZIP znaleziony: ${{ github.event.inputs.zip_path }}"
          ls -lh ${{ github.event.inputs.zip_path }}

      - name: Extract workspace
        run: |
          mkdir -p workspace
          unzip -q ${{ github.event.inputs.zip_path }} -d workspace
          echo "üìÇ Zawarto≈õƒá workspace:"
          ls -R workspace | head -n 50

      - name: Select Xcode and check version
        run: |
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Build iOS app (Release, no signing)
        run: |
          cd workspace/platforms/ios
          echo "üîç Wykrywanie schematu..."
          SCHEME=$(xcodebuild -list -json | jq -r '.workspace.schemes[0]')
          echo "üì¶ Scheme: $SCHEME"

          xcodebuild \
            -workspace *.xcworkspace \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            clean build | tee ../../build_log.txt

      - name: Create unsigned .ipa
        run: |
          APP_PATH=$(find workspace/platforms/ios/build -type d -name "*.app" | head -n 1)
          echo "üì± App path: $APP_PATH"

          mkdir -p workspace/output/Payload
          cp -R "$APP_PATH" workspace/output/Payload/
          cd workspace/output
          zip -r ../MyApp-unsigned.ipa Payload
          cd ../..
          echo "‚úÖ Utworzono IPA: workspace/MyApp-unsigned.ipa"

      - name: Upload unsigned IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: |
            workspace/MyApp-unsigned.ipa
            workspace/build_log.txt
